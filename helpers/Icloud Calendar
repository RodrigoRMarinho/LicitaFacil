# helpers/icloud_calendar.py

import datetime
from typing import List, Dict
from pyicloud import PyiCloudService

def autenticar_icloud(usuario: str, senha: str) -> PyiCloudService:
    """
    Autentica no iCloud com tratamento de 2FA
    
    Args:
        usuario: Email do iCloud
        senha: Senha da conta
    
    Returns:
        Inst√¢ncia autenticada do PyiCloudService
    """
    icloud = PyiCloudService(usuario, senha)
    
    if icloud.requires_2fa:
        print("\nüîê Autentica√ß√£o de dois fatores necess√°ria")
        code = input("Digite o c√≥digo recebido em seu dispositivo Apple: ")
        if not icloud.validate_2fa_code(code):
            raise ValueError("‚ùå C√≥digo 2FA inv√°lido")
        print("‚úÖ Autentica√ß√£o conclu√≠da")
    
    return icloud

def adicionar_eventos_na_agenda(icloud: PyiCloudService, eventos: List[Dict]):
    """
    Adiciona eventos √† agenda do iCloud
    
    Args:
        icloud: Sess√£o autenticada
        eventos: Lista de dicion√°rios com dados dos eventos
    """
    if not icloud.calendar:
        raise RuntimeError("Servi√ßo de calend√°rio n√£o dispon√≠vel")
    
    for evento in eventos:
        try:
            # Converte datas
            data_inicio = datetime.datetime.strptime(
                f"{evento['Data do Preg√£o']} {evento['Hor√°rio']}", 
                "%Y-%m-%d %H:%M"
            )
            data_fim = data_inicio + datetime.timedelta(hours=1)
            
            # Cria evento usando a API correta
            icloud.calendar.post(
                {
                    'title': f"Preg√£o {evento['N¬∫ do Edital']} ‚Äì {evento['√ìrg√£o']}",
                    'startDate': data
